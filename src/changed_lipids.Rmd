---
title: "Significant Lipids correlated with top RNA-seq genes"
author: "Timothy Yu"
date: "6/24/24"
output: html_document
---
```{r setup, include=FALSE}
library(tidyverse)
library(viridis)
require(cowplot)
theme_set(theme_cowplot())
```

```{r}
top50gene_x_liver_lipid = read.csv('../processed_data/correlations/top50gene_x_liver_lipid.csv', 
                                   header = TRUE, stringsAsFactors = FALSE, check.names = FALSE)
```

```{r}
# too many lipids, so figure out which ones are most abundant
lipid_abundance = read.csv('../processed_data/datasets/Lipidomics_liver.csv', header = TRUE,
                     stringsAsFactors = FALSE, check.names = FALSE) %>%
  pivot_longer(cols = -c(ID, Treatment),
               names_to = "Lipid",
               values_to = "Abundance") %>%
  group_by(Lipid) %>%
  mutate(Max_abundance = max(Abundance, na.rm = TRUE)) %>%
  ungroup() %>%
  select(Lipid, Max_abundance) %>%
  distinct()
```

```{r}
top50gene_x_liver_lipid_filtered = top50gene_x_liver_lipid %>% 
  filter(bicor > 0.7, adj_pval < 0.05) %>%
  group_by(Liver_lipid) %>%
  mutate(Num_significant_corrs = n()) %>%
  ungroup() %>% 
  mutate(Lipid_class = ifelse(grepl("^PE\\.O\\.|^PE\\.P\\.", Liver_lipid),
                              sub("\\.", "_", str_extract(Liver_lipid, "^PE\\..")),
                              str_extract(Liver_lipid, "^[^.]+"))) %>% drop_na() %>%
  left_join(., lipid_abundance, by = c("Liver_lipid"="Lipid")) %>%
  group_by(Lipid_class) %>%
  slice_max(order_by = Max_abundance, n = 20) %>%
  ungroup()

length(unique(top50gene_x_liver_lipid_filtered$Liver_lipid))

write.csv(top50gene_x_liver_lipid_filtered,
          '../processed_data/misc/plot_sig_top50gene_x_liver_lipid.csv', row.names = FALSE, quote = FALSE)
```
